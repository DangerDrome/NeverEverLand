<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baking Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: monospace;
            background: #222;
            color: #fff;
        }
        #results {
            white-space: pre-wrap;
            background: #111;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #44f;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background: #66f;
        }
    </style>
</head>
<body>
    <h1>Voxel Baking System Test</h1>
    <button onclick="runTest()">Run Baking Test</button>
    <div id="results"></div>

    <script type="module">
        import { VoxelType } from './src/types.js';
        import { BakedMeshGenerator } from './src/engine/BakedMeshGenerator.js';
        import { SimpleBakedMeshGenerator } from './src/engine/SimpleBakedMeshGenerator.js';

        window.runTest = function() {
            const results = document.getElementById('results');
            results.textContent = 'Running baking test...\n\n';

            // Create a simple 3x3x3 cube
            const voxels = new Map();
            for (let x = 0; x < 3; x++) {
                for (let y = 0; y < 3; y++) {
                    for (let z = 0; z < 3; z++) {
                        voxels.set(`${x},${y},${z}`, VoxelType.GRASS);
                    }
                }
            }

            results.textContent += `Created ${voxels.size} voxels (3x3x3 cube)\n\n`;

            // Test SimpleBakedMeshGenerator
            results.textContent += '=== SimpleBakedMeshGenerator ===\n';
            const simpleGen = new SimpleBakedMeshGenerator(0.1);
            const simpleResult = simpleGen.generateSimpleMesh(voxels);
            
            results.textContent += `Faces: ${simpleResult.metadata.faceCount}\n`;
            results.textContent += `Vertices: ${simpleResult.metadata.vertexCount}\n`;
            results.textContent += `Expected: 54 faces (6 sides × 9 voxels per side)\n\n`;

            // Test BakedMeshGenerator
            results.textContent += '=== BakedMeshGenerator (Greedy Meshing) ===\n';
            const bakedGen = new BakedMeshGenerator(0.1);
            const bakedResult = bakedGen.generateOptimizedMesh(voxels);
            
            results.textContent += `Faces: ${bakedResult.metadata.faceCount}\n`;
            results.textContent += `Vertices: ${bakedResult.metadata.vertexCount}\n`;
            results.textContent += `Expected: 6 faces (1 per side with greedy meshing)\n\n`;

            // Calculate reduction
            const faceReduction = ((1 - bakedResult.metadata.faceCount / simpleResult.metadata.faceCount) * 100).toFixed(1);
            const vertexReduction = ((1 - bakedResult.metadata.vertexCount / simpleResult.metadata.vertexCount) * 100).toFixed(1);
            
            results.textContent += '=== Performance ===\n';
            results.textContent += `Face reduction: ${faceReduction}%\n`;
            results.textContent += `Vertex reduction: ${vertexReduction}%\n`;

            // Check if meshes exist
            results.textContent += '\n=== Mesh Generation ===\n';
            results.textContent += `Simple opaque mesh: ${simpleResult.opaqueMesh ? 'Created' : 'Missing'}\n`;
            results.textContent += `Baked opaque mesh: ${bakedResult.opaqueMesh ? 'Created' : 'Missing'}\n`;

            // Check geometry details if available
            if (simpleResult.opaqueMesh && bakedResult.opaqueMesh) {
                const simplePos = simpleResult.opaqueMesh.geometry.getAttribute('position');
                const bakedPos = bakedResult.opaqueMesh.geometry.getAttribute('position');
                
                results.textContent += '\n=== Geometry Details ===\n';
                results.textContent += `Simple mesh position count: ${simplePos.count}\n`;
                results.textContent += `Baked mesh position count: ${bakedPos.count}\n`;
                
                // Log first vertex position from each mesh
                results.textContent += '\nFirst vertex positions:\n';
                results.textContent += `Simple: (${simplePos.array[0].toFixed(2)}, ${simplePos.array[1].toFixed(2)}, ${simplePos.array[2].toFixed(2)})\n`;
                results.textContent += `Baked: (${bakedPos.array[0].toFixed(2)}, ${bakedPos.array[1].toFixed(2)}, ${bakedPos.array[2].toFixed(2)})\n`;
            }

            results.textContent += '\n✅ Test complete!';
        };
    </script>
</body>
</html>